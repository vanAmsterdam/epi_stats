<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Wouter van Amsterdam" />

<meta name="date" content="2018-02-12" />

<title>Assignments Computational Statistics</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">epi_stats</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/jdblischak/workflowr">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Assignments Computational Statistics</h1>
<h4 class="author"><em>Wouter van Amsterdam</em></h4>
<h4 class="date"><em>2018-02-12</em></h4>

</div>


<!-- The file analysis/chunks.R contains chunks that define default settings
shared across the workflowr files. -->
<!-- Update knitr chunk options -->
<!-- Insert the date the file was last updated -->
<p><strong>Last updated:</strong> 2018-02-14</p>
<!-- Insert the code version (Git commit SHA1) if Git repository exists and R
 package git2r is installed -->
<p><strong>Code version:</strong> 4a4abb1</p>
<!-- Add your analysis here -->
<div id="setup" class="section level1">
<h1>Setup</h1>
<pre class="r"><code>library(dplyr)
library(data.table)
library(magrittr)
library(purrr)
library(here) # for tracking working directory</code></pre>
</div>
<div id="day-1-advanced-r" class="section level1">
<h1>Day 1 advanced-R</h1>
<div id="excercise-1-a-coinflip-function" class="section level2">
<h2>Excercise 1, A Coinflip function</h2>
<div id="a-custom-dice-roll-function" class="section level3">
<h3>A custom dice roll function</h3>
<pre class="r"><code>coinflip &lt;- function(num){
  sample(x = c(1,2), size = num, replace = TRUE)
  }</code></pre>
<p>Make dice roll function</p>
<pre class="r"><code>diceroll &lt;- function(num) {
  sample(x = 1:6, size = num, replace = TRUE)
}

diceroll(4)</code></pre>
<pre><code>[1] 5 6 5 6</code></pre>
</div>
<div id="b-dice-roll-with-arbitrary-number-of-sides" class="section level3">
<h3>B Dice roll with arbitrary number of sides</h3>
<pre class="r"><code>diceroll2 &lt;- function(num, sides) {
  sample(x = 1:sides, size = num, replace = TRUE)
}

diceroll2(num = 4, sides = 4)</code></pre>
<pre><code>[1] 2 1 2 3</code></pre>
</div>
<div id="c-averages-of-dice-roll" class="section level3">
<h3>C Averages of dice roll</h3>
<p>Take dice with 6 sides, which was <code>diceroll</code></p>
<p>Let’s roll the dice 1, 10, 100, 1000 and 10000 times, calculate the mean, and do this 1000 times</p>
<p>We will use the package <code>purrr</code> to map functions to the list of number of throws</p>
<pre class="r"><code>require(magrittr)
require(purrr)
nsim = 1000

nthrow = 10^(0:4)

nthrows &lt;- rep(nthrow, times = nsim)

nthrow %&gt;%
  map(diceroll) %&gt;%
  map_dbl(mean)</code></pre>
<pre><code>[1] 5.0000 2.8000 3.6700 3.5860 3.4904</code></pre>
<pre class="r"><code>means &lt;- list(nthrows) %&gt;%
  pmap(diceroll) %&gt;% # apply diceroll to each row of nthrows, returns a list
  map_dbl(mean)      # apply mean to each element of the list, return a double vector

df &lt;- data.frame(nthrows, means)</code></pre>
<p>Visualize results</p>
<pre class="r"><code>require(ggplot2)

df %&gt;%
  ggplot(aes(x = nthrows, y = means)) +
  geom_point(alpha = .1) + 
  scale_x_log10() + theme_minimal() + 
  ggtitle(&quot;Means of 1000 simulations of n-dice throws&quot;) + 
  labs(x = &quot;Number of throws&quot;)</code></pre>
<p><img src="figure/cs_assignments.Rmd/unnamed-chunk-6-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Now with uniform sampling on logarithmic scale</p>
<pre class="r"><code>nthrows &lt;- round(10^runif(min = 0, max = 4, n = nsim))
means &lt;- list(nthrows) %&gt;%
  pmap(diceroll) %&gt;% # apply diceroll to each row of nthrows, returns a list
  map_dbl(mean)      # apply mean to each element of the list, return a double vector

df &lt;- data.frame(nthrows, means)

df %&gt;%
  ggplot(aes(x = nthrows, y = means)) +
  geom_point(alpha = .1) + 
  scale_x_log10() + theme_minimal() + 
  ggtitle(&quot;Means of 1000 simulations of n-dice throws&quot;) + 
  labs(x = &quot;Number of throws&quot;)</code></pre>
<p><img src="figure/cs_assignments.Rmd/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Or with base-R plot</p>
<pre class="r"><code>plot(means~nthrows, data = df, log = &quot;x&quot;)</code></pre>
<p><img src="figure/cs_assignments.Rmd/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="tables" class="section level2">
<h2>2 tables</h2>
<p>Get data</p>
<pre class="r"><code>smokedat &lt;- data.frame(
  id = 1:20,
  smoking.status = c(NA, &quot;never smoked&quot;, &quot;never smoked&quot;, &quot;never smoked&quot;, &quot;never smoked&quot;, &quot;never smoked&quot;, &quot;never smoked&quot;, &quot;has smoked&quot;, &quot;has smoked&quot;, &quot;has smoked&quot;, &quot;has smoked&quot;, &quot;has smoked&quot;, &quot;has smoked&quot;, &quot;currently smoking&quot;, &quot;currently smoking&quot;, &quot;currently smoking&quot;, &quot;currently smoking&quot;, &quot;currently smoking&quot;, &quot;currently smoking&quot;, &quot;currently smoking&quot;),
  outcome = c(&quot;no hart infarction&quot;, NA, &quot;no hart infarction&quot;, &quot;no hart infarction&quot;, &quot;no hart infarction&quot;, &quot;no hart infarction&quot;, &quot;hart infarction&quot;, &quot;no hart infarction&quot;, &quot;no hart infarction&quot;, &quot;no hart infarction&quot;, &quot;no hart infarction&quot;, &quot;hart infarction&quot;, &quot;hart infarction&quot;, &quot;hart infarction&quot;, &quot;no hart infarction&quot;, &quot;no hart infarction&quot;, &quot;no hart infarction&quot;, &quot;hart infarction&quot;, &quot;hart infarction&quot;, &quot;hart infarction&quot;)
    )</code></pre>
<p>View</p>
<pre class="r"><code>smokedat</code></pre>
<pre><code>   id    smoking.status            outcome
1   1              &lt;NA&gt; no hart infarction
2   2      never smoked               &lt;NA&gt;
3   3      never smoked no hart infarction
4   4      never smoked no hart infarction
5   5      never smoked no hart infarction
6   6      never smoked no hart infarction
7   7      never smoked    hart infarction
8   8        has smoked no hart infarction
9   9        has smoked no hart infarction
10 10        has smoked no hart infarction
11 11        has smoked no hart infarction
12 12        has smoked    hart infarction
13 13        has smoked    hart infarction
14 14 currently smoking    hart infarction
15 15 currently smoking no hart infarction
16 16 currently smoking no hart infarction
17 17 currently smoking no hart infarction
18 18 currently smoking    hart infarction
19 19 currently smoking    hart infarction
20 20 currently smoking    hart infarction</code></pre>
<div id="a-get-help" class="section level3">
<h3>A Get help</h3>
<pre class="r"><code>?table</code></pre>
</div>
<div id="b-cross-table" class="section level3">
<h3>B cross table</h3>
<pre class="r"><code>table(smokedat$smoking.status, smokedat$outcome)</code></pre>
<pre><code>                   
                    hart infarction no hart infarction
  currently smoking               4                  3
  has smoked                      2                  4
  never smoked                    1                  4</code></pre>
</div>
<div id="c-with-missings" class="section level3">
<h3>C with missings</h3>
<blockquote>
<p>Modify the previous command, to also display the numbers of missing.</p>
</blockquote>
<pre class="r"><code>table(smokedat$smoking.status, smokedat$outcome, useNA = &quot;always&quot;)</code></pre>
<pre><code>                   
                    hart infarction no hart infarction &lt;NA&gt;
  currently smoking               4                  3    0
  has smoked                      2                  4    0
  never smoked                    1                  4    1
  &lt;NA&gt;                            0                  1    0</code></pre>
<blockquote>
<p>These tables are rather simple, we would like to add row and column totals as well as proportions.</p>
</blockquote>
</div>
<div id="d-add-margins" class="section level3">
<h3>D Add margins</h3>
<blockquote>
<p>Assign the table created in C) to an object called smoketab. Use the book, R forum, Google, etc. to find the commands to calculate row and column sums. In the same way, find the commands to bind rows and columns. Apply the above commands to create smoketab2, with the row totals added to smoketab as a new column. In addition, create smoketab3 with the column totals added to smoketab2 as a new row.</p>
</blockquote>
<pre class="r"><code>smoketab &lt;- table(smokedat$smoking.status, smokedat$outcome, useNA = &quot;always&quot;)

smoketab2 &lt;- cbind(smoketab, total = rowSums(smoketab))
smoketab3 &lt;- rbind(smoketab2, total = colSums(smoketab2))
smoketab3</code></pre>
<pre><code>                  hart infarction no hart infarction &lt;NA&gt; total
currently smoking               4                  3    0     7
has smoked                      2                  4    0     6
never smoked                    1                  4    1     6
&lt;NA&gt;                            0                  1    0     1
total                           7                 12    1    20</code></pre>
</div>
<div id="e-proportions" class="section level3">
<h3>E: Proportions</h3>
<blockquote>
<p>Calculate row proportions for smoketab3 (hint: You can divide smoketab3 by the row totals). Store the new table in an object called smoketab3.RP.</p>
</blockquote>
<p>Each row get’s multiplied with 1 divided by the sum of the columns</p>
<p>We can create a matrix with 1 over the column totals, and do element-wise product</p>
<pre class="r"><code>totals &lt;- tail(smoketab3, 1)
total_matrix &lt;- matrix(rep(1/totals, nrow(smoketab3)), 
                       nrow = nrow(smoketab3), byrow = T)
total_matrix</code></pre>
<pre><code>          [,1]       [,2] [,3] [,4]
[1,] 0.1428571 0.08333333    1 0.05
[2,] 0.1428571 0.08333333    1 0.05
[3,] 0.1428571 0.08333333    1 0.05
[4,] 0.1428571 0.08333333    1 0.05
[5,] 0.1428571 0.08333333    1 0.05</code></pre>
<pre class="r"><code>smoketab3.RP &lt;- smoketab3 * total_matrix
smoketab3.RP</code></pre>
<pre><code>                  hart infarction no hart infarction &lt;NA&gt; total
currently smoking       0.5714286         0.25000000    0  0.35
has smoked              0.2857143         0.33333333    0  0.30
never smoked            0.1428571         0.33333333    1  0.30
&lt;NA&gt;                    0.0000000         0.08333333    0  0.05
total                   1.0000000         1.00000000    1  1.00</code></pre>
</div>
<div id="f-column-proportions" class="section level3">
<h3>F column proportions</h3>
<blockquote>
<p>Calculate columns proportions as well, in the same manner (note: you will need to transpose the table, and then transpose back afterwards). Store the new table in an object called smoketab3.CP.</p>
</blockquote>
<pre class="r"><code>col_totals &lt;- smoketab3[, &quot;total&quot;]
col_total_matrix &lt;- matrix(rep(1/col_totals, each = ncol(smoketab3)),
                           nrow = nrow(smoketab3), byrow = T)
col_total_matrix</code></pre>
<pre><code>          [,1]      [,2]      [,3]      [,4]
[1,] 0.1428571 0.1428571 0.1428571 0.1428571
[2,] 0.1666667 0.1666667 0.1666667 0.1666667
[3,] 0.1666667 0.1666667 0.1666667 0.1666667
[4,] 1.0000000 1.0000000 1.0000000 1.0000000
[5,] 0.0500000 0.0500000 0.0500000 0.0500000</code></pre>
<pre class="r"><code>smoketab3.CP &lt;- smoketab3 * col_total_matrix
smoketab3.CP</code></pre>
<pre><code>                  hart infarction no hart infarction      &lt;NA&gt; total
currently smoking       0.5714286          0.4285714 0.0000000     1
has smoked              0.3333333          0.6666667 0.0000000     1
never smoked            0.1666667          0.6666667 0.1666667     1
&lt;NA&gt;                    0.0000000          1.0000000 0.0000000     1
total                   0.3500000          0.6000000 0.0500000     1</code></pre>
</div>
<div id="g-list-of-matrices" class="section level3">
<h3>G list of matrices</h3>
<blockquote>
<p>using the list() command, produce a list containing smoketab3, smoketab3.RP and smoketab3.CP. Name these three components “tab”, “rowprop” and “colprop”, respectively.</p>
</blockquote>
<pre class="r"><code>tab_list &lt;- list(tab = smoketab3, rowprop = smoketab3.RP, colprop = smoketab3.CP)</code></pre>
</div>
<div id="h-improved-tablefunction" class="section level3">
<h3>H improved tablefunction</h3>
<blockquote>
<p>Now make an improved table function yourself. Note: build a function that uses the arguments variable1, variable2 and dat, to produce a list such as you made in A) - G). variable1 and variable2 should be character values (containing text between quotes). Note that selection of columns or rows can also be done e.g. using smokedat[,“smoking.status”] (try it).</p>
</blockquote>
<pre class="r"><code>table2 &lt;- function(data, variable1, variable2) {
  x &lt;- data[[variable1]]
  y &lt;- data[[variable2]]
  
  # use dnn to preserve variable names
  tab &lt;- table(x, y, dnn = c(variable1, variable2), useNA = &quot;always&quot;)
  
  row_totals &lt;- rowSums(tab)
  tab2 &lt;- cbind(tab, total = row_totals)
  
  col_totals &lt;- colSums(tab2)
  tab3 &lt;- rbind(tab2, total = col_totals)
  
  # update col and row totals
  row_totals &lt;- rowSums(tab3) / 2
  col_totals &lt;- colSums(tab3) / 2

  row_total_matrix &lt;- matrix(rep(row_totals, each = ncol(tab3)), 
                       nrow = nrow(tab3), byrow = T)
  col_total_matrix &lt;- matrix(rep(col_totals, each = nrow(tab3)), 
                       nrow = nrow(tab3), byrow = F)
  
  tab3.RP &lt;- tab3 / row_total_matrix
  tab3.CP &lt;- tab3 / col_total_matrix
  
  tabs &lt;- list(tab = tab3, rowprop = tab3.RP, colprop = tab3.CP)

  return(tabs)
  
}

table2(smokedat, &quot;smoking.status&quot;, &quot;outcome&quot;)</code></pre>
<pre><code>$tab
                  hart infarction no hart infarction &lt;NA&gt; total
currently smoking               4                  3    0     7
has smoked                      2                  4    0     6
never smoked                    1                  4    1     6
&lt;NA&gt;                            0                  1    0     1
total                           7                 12    1    20

$rowprop
                  hart infarction no hart infarction      &lt;NA&gt; total
currently smoking       0.5714286          0.4285714 0.0000000     1
has smoked              0.3333333          0.6666667 0.0000000     1
never smoked            0.1666667          0.6666667 0.1666667     1
&lt;NA&gt;                    0.0000000          1.0000000 0.0000000     1
total                   0.3500000          0.6000000 0.0500000     1

$colprop
                  hart infarction no hart infarction &lt;NA&gt; total
currently smoking       0.5714286         0.25000000    0  0.35
has smoked              0.2857143         0.33333333    0  0.30
never smoked            0.1428571         0.33333333    1  0.30
&lt;NA&gt;                    0.0000000         0.08333333    0  0.05
total                   1.0000000         1.00000000    1  1.00</code></pre>
</div>
<div id="i-find-updated-table-function" class="section level3">
<h3>I find updated table function</h3>
<blockquote>
<p>In the book, R forum, internet or elsewhere, can you find a crosstable function that provides similar functionality (row and column totals and proportions)?</p>
</blockquote>
<p>I googled for ‘r package table with proportions and margins’</p>
<p>Found: gmodels on the website Quick-R</p>
<p>Works like:</p>
<pre class="r"><code>gmodels::CrossTable(smokedat$smoking.status, smokedat$outcome)</code></pre>
<pre><code>
 
   Cell Contents
|-------------------------|
|                       N |
| Chi-square contribution |
|           N / Row Total |
|           N / Col Total |
|         N / Table Total |
|-------------------------|

 
Total Observations in Table:  18 

 
                        | smokedat$outcome 
smokedat$smoking.status |    hart infarction | no hart infarction |          Row Total | 
------------------------|--------------------|--------------------|--------------------|
      currently smoking |                  4 |                  3 |                  7 | 
                        |              0.600 |              0.382 |                    | 
                        |              0.571 |              0.429 |              0.389 | 
                        |              0.571 |              0.273 |                    | 
                        |              0.222 |              0.167 |                    | 
------------------------|--------------------|--------------------|--------------------|
             has smoked |                  2 |                  4 |                  6 | 
                        |              0.048 |              0.030 |                    | 
                        |              0.333 |              0.667 |              0.333 | 
                        |              0.286 |              0.364 |                    | 
                        |              0.111 |              0.222 |                    | 
------------------------|--------------------|--------------------|--------------------|
           never smoked |                  1 |                  4 |                  5 | 
                        |              0.459 |              0.292 |                    | 
                        |              0.200 |              0.800 |              0.278 | 
                        |              0.143 |              0.364 |                    | 
                        |              0.056 |              0.222 |                    | 
------------------------|--------------------|--------------------|--------------------|
           Column Total |                  7 |                 11 |                 18 | 
                        |              0.389 |              0.611 |                    | 
------------------------|--------------------|--------------------|--------------------|

 </code></pre>
</div>
<div id="j-add-rounding" class="section level3">
<h3>J add rounding</h3>
<blockquote>
<p>If you still have time, make an improved version of the function that you made in H) that includes rounding of the decimals in rowprop and colprop.</p>
</blockquote>
<pre class="r"><code>table3 &lt;- function(data, variable1, variable2, ndigits = NULL) {
  x &lt;- data[[variable1]]
  y &lt;- data[[variable2]]
  
  # use dnn to preserve variable names
  tab &lt;- table(x, y, dnn = c(variable1, variable2), useNA = &quot;always&quot;)
  
  row_totals &lt;- rowSums(tab)
  tab2 &lt;- cbind(tab, total = row_totals)
  
  col_totals &lt;- colSums(tab2)
  tab3 &lt;- rbind(tab2, total = col_totals)
  
  # update col and row totals
  row_totals &lt;- rowSums(tab3) / 2
  col_totals &lt;- colSums(tab3) / 2

  row_total_matrix &lt;- matrix(rep(row_totals, each = ncol(tab3)), 
                       nrow = nrow(tab3), byrow = T)
  col_total_matrix &lt;- matrix(rep(col_totals, each = nrow(tab3)), 
                       nrow = nrow(tab3), byrow = F)
  
  tab3.RP &lt;- tab3 / row_total_matrix
  tab3.CP &lt;- tab3 / col_total_matrix
  
  tabs &lt;- list(tab = tab3, rowprop = tab3.RP, colprop = tab3.CP)
  
  # no rounding
  if (is.null(ndigits)) return(tabs)

  # rounding
  tabs_rounded &lt;- tabs %&gt;%
    purrr::map(round, ndigits)
  return(tabs_rounded)
  
  
}

table3(smokedat, &quot;smoking.status&quot;, &quot;outcome&quot;)</code></pre>
<pre><code>$tab
                  hart infarction no hart infarction &lt;NA&gt; total
currently smoking               4                  3    0     7
has smoked                      2                  4    0     6
never smoked                    1                  4    1     6
&lt;NA&gt;                            0                  1    0     1
total                           7                 12    1    20

$rowprop
                  hart infarction no hart infarction      &lt;NA&gt; total
currently smoking       0.5714286          0.4285714 0.0000000     1
has smoked              0.3333333          0.6666667 0.0000000     1
never smoked            0.1666667          0.6666667 0.1666667     1
&lt;NA&gt;                    0.0000000          1.0000000 0.0000000     1
total                   0.3500000          0.6000000 0.0500000     1

$colprop
                  hart infarction no hart infarction &lt;NA&gt; total
currently smoking       0.5714286         0.25000000    0  0.35
has smoked              0.2857143         0.33333333    0  0.30
never smoked            0.1428571         0.33333333    1  0.30
&lt;NA&gt;                    0.0000000         0.08333333    0  0.05
total                   1.0000000         1.00000000    1  1.00</code></pre>
<pre class="r"><code>table3(smokedat, &quot;smoking.status&quot;, &quot;outcome&quot;, ndigits = 2)</code></pre>
<pre><code>$tab
                  hart infarction no hart infarction &lt;NA&gt; total
currently smoking               4                  3    0     7
has smoked                      2                  4    0     6
never smoked                    1                  4    1     6
&lt;NA&gt;                            0                  1    0     1
total                           7                 12    1    20

$rowprop
                  hart infarction no hart infarction &lt;NA&gt; total
currently smoking            0.57               0.43 0.00     1
has smoked                   0.33               0.67 0.00     1
never smoked                 0.17               0.67 0.17     1
&lt;NA&gt;                         0.00               1.00 0.00     1
total                        0.35               0.60 0.05     1

$colprop
                  hart infarction no hart infarction &lt;NA&gt; total
currently smoking            0.57               0.25    0  0.35
has smoked                   0.29               0.33    0  0.30
never smoked                 0.14               0.33    1  0.30
&lt;NA&gt;                         0.00               0.08    0  0.05
total                        1.00               1.00    1  1.00</code></pre>
</div>
</div>
<div id="split-and-unsplit" class="section level2">
<h2>3 split and unsplit</h2>
<div id="a-load-data" class="section level3">
<h3>A load data</h3>
<blockquote>
<p>Load and examine the haartdat dataset. Note: This can be done using the function load().</p>
</blockquote>
<pre class="r"><code>load(here(&quot;data&quot;, &quot;haartdat.rda&quot;))
str(haartdat)</code></pre>
<pre><code>&#39;data.frame&#39;:   19175 obs. of  10 variables:
 $ patient : int  1 1 1 1 1 1 1 1 1 1 ...
 $ tstart  : num  -100 0 100 200 300 400 500 600 700 800 ...
 $ fuptime : num  0 100 200 300 400 500 600 700 800 900 ...
 $ haartind: num  0 0 0 0 0 0 0 1 1 1 ...
 $ event   : num  0 0 0 0 0 0 0 0 0 0 ...
 $ sex     : num  1 1 1 1 1 1 1 1 1 1 ...
 $ age     : num  22 22 22 22 22 22 22 22 22 22 ...
 $ cd4.sqrt: num  23.8 25.6 23.5 24.2 23.2 ...
 $ endtime : num  2900 2900 2900 2900 2900 2900 2900 2900 2900 2900 ...
 $ dropout : num  0 0 0 0 0 0 0 0 0 0 ...</code></pre>
</div>
<div id="b-split" class="section level3">
<h3>B Split</h3>
<blockquote>
<p>Try out the split() command in the following manner: * Split haartdat into a list of individual datasets, based on the patient ID * Name this list datlist * Look at some components in this list, e.g. the first, second or 20th component</p>
</blockquote>
<pre class="r"><code>uniqueN(haartdat$patient)</code></pre>
<pre><code>[1] 1200</code></pre>
<pre class="r"><code>datlist &lt;- base::split(haartdat, haartdat$patient)
datlist[[1]]</code></pre>
<pre><code>   patient tstart fuptime haartind event sex age cd4.sqrt endtime dropout
1        1   -100       0        0     0   1  22 23.83275    2900       0
2        1      0     100        0     0   1  22 25.59297    2900       0
3        1    100     200        0     0   1  22 23.47339    2900       0
4        1    200     300        0     0   1  22 24.16609    2900       0
5        1    300     400        0     0   1  22 23.23790    2900       0
6        1    400     500        0     0   1  22 24.85961    2900       0
7        1    500     600        0     0   1  22 25.94224    2900       0
8        1    600     700        1     0   1  22 26.03843    2900       0
9        1    700     800        1     0   1  22 26.72078    2900       0
10       1    800     900        1     0   1  22 27.47726    2900       0
11       1    900    1000        1     0   1  22 23.87467    2900       0
12       1   1000    1100        1     0   1  22 28.30194    2900       0
13       1   1100    1200        1     0   1  22 25.72936    2900       0
14       1   1200    1300        1     0   1  22 22.62742    2900       0
15       1   1300    1400        1     0   1  22 30.16621    2900       0
16       1   1400    1500        1     0   1  22 23.04344    2900       0
17       1   1500    1600        1     0   1  22 25.09980    2900       0
18       1   1600    1700        1     0   1  22 23.62202    2900       0
19       1   1700    1800        1     0   1  22 23.49468    2900       0
20       1   1800    1900        1     0   1  22 26.57066    2900       0
21       1   1900    2000        1     0   1  22 28.47806    2900       0
22       1   2000    2100        1     0   1  22 20.59126    2900       0
23       1   2100    2200        1     0   1  22 23.87467    2900       0
24       1   2200    2300        1     0   1  22 25.53429    2900       0
25       1   2300    2400        1     0   1  22 22.56103    2900       0
26       1   2400    2500        1     0   1  22 21.93171    2900       0
27       1   2500    2600        1     0   1  22 28.23119    2900       0
28       1   2600    2700        1     0   1  22 21.97726    2900       0
29       1   2700    2800        1     0   1  22 22.84732    2900       0
30       1   2800    2900        1     0   1  22 26.85144    2900       1</code></pre>
<pre class="r"><code>datlist[[10]]</code></pre>
<pre><code>    patient tstart fuptime haartind event sex age cd4.sqrt endtime dropout
258      10   -100       0        0     0   0  35 16.21727    2900       0
259      10      0     100        0     0   0  35 18.73499    2900       0
260      10    100     200        1     0   0  35 14.42221    2900       0
261      10    200     300        1     0   0  35 17.88854    2900       0
262      10    300     400        1     0   0  35 17.97220    2900       0
263      10    400     500        1     0   0  35 16.94107    2900       0
264      10    500     600        1     0   0  35 17.05872    2900       0
265      10    600     700        1     0   0  35 18.38478    2900       0
266      10    700     800        1     0   0  35 20.00000    2900       0
267      10    800     900        1     0   0  35 14.69694    2900       0
268      10    900    1000        1     0   0  35 15.68439    2900       0
269      10   1000    1100        1     0   0  35 18.60108    2900       0
270      10   1100    1200        1     0   0  35 15.87451    2900       0
271      10   1200    1300        1     0   0  35 15.90597    2900       0
272      10   1300    1400        1     0   0  35 16.15549    2900       0
273      10   1400    1500        1     0   0  35 14.59452    2900       0
274      10   1500    1600        1     0   0  35 18.81489    2900       0
275      10   1600    1700        1     0   0  35 14.03567    2900       0
276      10   1700    1800        1     0   0  35 16.12452    2900       0
277      10   1800    1900        1     0   0  35 15.16575    2900       0
278      10   1900    2000        1     0   0  35 14.10674    2900       0
279      10   2000    2100        1     0   0  35 14.56022    2900       0
280      10   2100    2200        1     0   0  35 15.68439    2900       0
281      10   2200    2300        1     0   0  35 13.45362    2900       0
282      10   2300    2400        1     0   0  35 12.76715    2900       0
283      10   2400    2500        1     0   0  35 15.29706    2900       0
284      10   2500    2600        1     0   0  35 13.22876    2900       0
285      10   2600    2700        1     0   0  35 13.60147    2900       0
286      10   2700    2800        1     0   0  35 10.58301    2900       0
287      10   2800    2900        1     0   0  35 11.00000    2900       1</code></pre>
<pre class="r"><code>length(datlist)</code></pre>
<pre><code>[1] 1200</code></pre>
</div>
<div id="c-unsplit" class="section level3">
<h3>C unsplit</h3>
<blockquote>
<p>Reverse the splitting operation by unsplit(), name the resulting object haartdat2. Are haartdat and haartdat2 identical? (Hint: take a summary of haartdat - haartdat2).</p>
</blockquote>
<pre class="r"><code>haartdat2 &lt;- unsplit(datlist, haartdat$patient)
summary(haartdat2 - haartdat)</code></pre>
<pre><code>    patient      tstart     fuptime     haartind     event        sex   
 Min.   :0   Min.   :0   Min.   :0   Min.   :0   Min.   :0   Min.   :0  
 1st Qu.:0   1st Qu.:0   1st Qu.:0   1st Qu.:0   1st Qu.:0   1st Qu.:0  
 Median :0   Median :0   Median :0   Median :0   Median :0   Median :0  
 Mean   :0   Mean   :0   Mean   :0   Mean   :0   Mean   :0   Mean   :0  
 3rd Qu.:0   3rd Qu.:0   3rd Qu.:0   3rd Qu.:0   3rd Qu.:0   3rd Qu.:0  
 Max.   :0   Max.   :0   Max.   :0   Max.   :0   Max.   :0   Max.   :0  
      age       cd4.sqrt    endtime     dropout 
 Min.   :0   Min.   :0   Min.   :0   Min.   :0  
 1st Qu.:0   1st Qu.:0   1st Qu.:0   1st Qu.:0  
 Median :0   Median :0   Median :0   Median :0  
 Mean   :0   Mean   :0   Mean   :0   Mean   :0  
 3rd Qu.:0   3rd Qu.:0   3rd Qu.:0   3rd Qu.:0  
 Max.   :0   Max.   :0   Max.   :0   Max.   :0  </code></pre>
<p>All zeros, so equal, check dimensions</p>
<pre class="r"><code>dim(haartdat)</code></pre>
<pre><code>[1] 19175    10</code></pre>
<pre class="r"><code>dim(haartdat2)</code></pre>
<pre><code>[1] 19175    10</code></pre>
</div>
<div id="d-minimum-by-patient" class="section level3">
<h3>D Minimum by patient</h3>
<blockquote>
<p>Suppose we want to determine the minimum of the CD4 counts for each patient. Make an individual dataset inddat, containing one row for each patient, with only the patient ID (HINT: use unique()). Split the CD4 measurements in haartdat per individual, name this object cd4.split. Using sapply(), take the minimum of CD4 count for each individual, and add the resulting vector to inddat.</p>
</blockquote>
<pre class="r"><code>inddat &lt;- unique(haartdat$patient)

cd4.split &lt;- split(haartdat$cd4.sqrt, haartdat$patient)

cd4s &lt;- sapply(cd4.split, min)

inddat &lt;- data.frame(patient = inddat, min_cd4 = cd4s)
head(inddat)</code></pre>
<pre><code>  patient  min_cd4
1       1 20.59126
2       2 18.05547
3       3 22.95648
4       4 19.64688
5       5 15.87451
6       6 23.62202</code></pre>
<p>We can do this we fewer lines of code using <code>dplyr</code></p>
<pre class="r"><code>haartdat %&gt;%
  group_by(patient) %&gt;%
  summarize(min_cd4 = min(cd4.sqrt))</code></pre>
<pre><code># A tibble: 1,200 x 2
   patient min_cd4
     &lt;int&gt;   &lt;dbl&gt;
 1       1   20.6 
 2       2   18.1 
 3       3   23.0 
 4       4   19.6 
 5       5   15.9 
 6       6   23.6 
 7       7   13.1 
 8       8    9.54
 9       9   16.2 
10      10   10.6 
# ... with 1,190 more rows</code></pre>
<p>Or using <code>data.table</code></p>
<pre class="r"><code>setDT(haartdat) # make data.table (only need to do this once)
haartdat[, list(min_cd4 = min(cd4.sqrt)), by = &quot;patient&quot;]</code></pre>
<pre><code>      patient  min_cd4
   1:       1 20.59126
   2:       2 18.05547
   3:       3 22.95648
   4:       4 19.64688
   5:       5 15.87451
  ---                 
1196:    1196 16.58312
1197:    1197 19.00000
1198:    1198 10.29563
1199:    1199 20.12461
1200:    1200 19.74842</code></pre>
</div>
<div id="e-max-per-patient" class="section level3">
<h3>E max per patient</h3>
<blockquote>
<p>Similarly to D), calculate for each patient the maximum of haartind, indicating if somewhere during the follow-up HAART was given. Add the resulting vector to inddat.</p>
</blockquote>
<p>Let’s use <code>data.table</code></p>
<pre class="r"><code>inddat &lt;- haartdat[, list(
  min_cd4 = min(cd4.sqrt), 
  haart = max(haartind)
), by = &quot;patient&quot;]

head(inddat)</code></pre>
<pre><code>   patient  min_cd4 haart
1:       1 20.59126     1
2:       2 18.05547     1
3:       3 22.95648     1
4:       4 19.64688     1
5:       5 15.87451     1
6:       6 23.62202     1</code></pre>
<pre class="r"><code>table(inddat$haart)</code></pre>
<pre><code>
  0   1 
824 376 </code></pre>
</div>
<div id="f-cumulative-haart" class="section level3">
<h3>F cumulative HAART</h3>
<blockquote>
<p>We would also like to compute for each patient the cumulative amount of HAART treatment at each time point. Hint: to transform a list object (e.g. listname) to a single numeric vector, you can use the command do.call(c, listname) (of course, this only works when the list only contains numeric values).</p>
</blockquote>
<p>We can get this by sorting on timepoint, and then calculating a cumulative sum of haart for each patient</p>
<pre class="r"><code>haartdat[order(tstart), cum_haart:=cumsum(haartind), by = &quot;patient&quot;]
haartdat[order(patient, tstart)][patient %in% unique(patient)[1:2]]</code></pre>
<pre><code>    patient tstart fuptime haartind event sex age cd4.sqrt endtime dropout
 1:       1   -100       0        0     0   1  22 23.83275    2900       0
 2:       1      0     100        0     0   1  22 25.59297    2900       0
 3:       1    100     200        0     0   1  22 23.47339    2900       0
 4:       1    200     300        0     0   1  22 24.16609    2900       0
 5:       1    300     400        0     0   1  22 23.23790    2900       0
 6:       1    400     500        0     0   1  22 24.85961    2900       0
 7:       1    500     600        0     0   1  22 25.94224    2900       0
 8:       1    600     700        1     0   1  22 26.03843    2900       0
 9:       1    700     800        1     0   1  22 26.72078    2900       0
10:       1    800     900        1     0   1  22 27.47726    2900       0
11:       1    900    1000        1     0   1  22 23.87467    2900       0
12:       1   1000    1100        1     0   1  22 28.30194    2900       0
13:       1   1100    1200        1     0   1  22 25.72936    2900       0
14:       1   1200    1300        1     0   1  22 22.62742    2900       0
15:       1   1300    1400        1     0   1  22 30.16621    2900       0
16:       1   1400    1500        1     0   1  22 23.04344    2900       0
17:       1   1500    1600        1     0   1  22 25.09980    2900       0
18:       1   1600    1700        1     0   1  22 23.62202    2900       0
19:       1   1700    1800        1     0   1  22 23.49468    2900       0
20:       1   1800    1900        1     0   1  22 26.57066    2900       0
21:       1   1900    2000        1     0   1  22 28.47806    2900       0
22:       1   2000    2100        1     0   1  22 20.59126    2900       0
23:       1   2100    2200        1     0   1  22 23.87467    2900       0
24:       1   2200    2300        1     0   1  22 25.53429    2900       0
25:       1   2300    2400        1     0   1  22 22.56103    2900       0
26:       1   2400    2500        1     0   1  22 21.93171    2900       0
27:       1   2500    2600        1     0   1  22 28.23119    2900       0
28:       1   2600    2700        1     0   1  22 21.97726    2900       0
29:       1   2700    2800        1     0   1  22 22.84732    2900       0
30:       1   2800    2900        1     0   1  22 26.85144    2900       1
31:       2   -100       0        0     0   0  21 18.05547    3300       0
32:       2      0     100        0     0   0  21 20.46949    3300       0
33:       2    100     200        1     0   0  21 22.89105    3300       0
34:       2    200     300        1     0   0  21 26.64583    3300       0
35:       2    300     400        1     0   0  21 22.02272    3300       0
36:       2    400     500        1     0   0  21 22.67157    3300       0
37:       2    500     600        1     0   0  21 24.91987    3300       0
38:       2    600     700        1     0   0  21 23.08679    3300       0
39:       2    700     800        1     0   0  21 22.93469    3300       0
40:       2    800     900        1     0   0  21 28.00000    3300       0
41:       2    900    1000        1     0   0  21 24.69818    3300       0
42:       2   1000    1100        1     0   0  21 25.09980    3300       0
43:       2   1100    1200        1     0   0  21 28.40775    3300       0
44:       2   1200    1300        1     0   0  21 27.11088    3300       0
45:       2   1300    1400        1     0   0  21 28.33725    3300       0
46:       2   1400    1500        1     0   0  21 25.39685    3300       0
47:       2   1500    1600        1     0   0  21 26.22975    3300       0
48:       2   1600    1700        1     0   0  21 26.98148    3300       0
49:       2   1700    1800        1     0   0  21 28.03569    3300       0
50:       2   1800    1900        1     0   0  21 27.42262    3300       0
51:       2   1900    2000        1     0   0  21 27.82086    3300       0
52:       2   2000    2100        1     0   0  21 26.98148    3300       0
53:       2   2100    2200        1     0   0  21 29.05168    3300       0
54:       2   2200    2300        1     0   0  21 29.46184    3300       0
55:       2   2300    2400        1     0   0  21 28.35489    3300       0
56:       2   2400    2500        1     0   0  21 26.68333    3300       0
57:       2   2500    2600        1     0   0  21 23.10844    3300       0
58:       2   2600    2700        1     0   0  21 25.47548    3300       0
59:       2   2700    2800        1     0   0  21 28.80972    3300       0
60:       2   2800    2900        1     0   0  21 27.80288    3300       0
61:       2   2900    3000        1     0   0  21 26.83282    3300       0
62:       2   3000    3100        1     0   0  21 28.74022    3300       0
63:       2   3100    3200        1     0   0  21 27.38613    3300       0
64:       2   3200    3300        1     0   0  21 28.35489    3300       0
    patient tstart fuptime haartind event sex age cd4.sqrt endtime dropout
    cum_haart
 1:         0
 2:         0
 3:         0
 4:         0
 5:         0
 6:         0
 7:         0
 8:         1
 9:         2
10:         3
11:         4
12:         5
13:         6
14:         7
15:         8
16:         9
17:        10
18:        11
19:        12
20:        13
21:        14
22:        15
23:        16
24:        17
25:        18
26:        19
27:        20
28:        21
29:        22
30:        23
31:         0
32:         0
33:         1
34:         2
35:         3
36:         4
37:         5
38:         6
39:         7
40:         8
41:         9
42:        10
43:        11
44:        12
45:        13
46:        14
47:        15
48:        16
49:        17
50:        18
51:        19
52:        20
53:        21
54:        22
55:        23
56:        24
57:        25
58:        26
59:        27
60:        28
61:        29
62:        30
63:        31
64:        32
    cum_haart</code></pre>
</div>
</div>
<div id="simulating-longitudinal-patient-data" class="section level2">
<h2>4 Simulating longitudinal patient data</h2>
<blockquote>
<p>The goal of this exercise is to simulate longitudinal patient data (n = 100). As an example, we use the development of CD4 count in HIV positive individuals. We consider development since the moment of HIV seroconversion (= t0). Typically, CD4 count decreases over time after seroconversion. For now, we assume that the square root of CD4 count decrease linearly over time. We further assume each patient has a different intercept and slope for sqrt(CD4).</p>
</blockquote>
<div id="a" class="section level3">
<h3>A</h3>
<blockquote>
<p>Build a data frame called basdat, containing patient IDs 1, 2, …, 100.</p>
</blockquote>
<pre class="r"><code>basdat &lt;- data.frame(id = 1:100)</code></pre>
</div>
<div id="b" class="section level3">
<h3>B</h3>
<blockquote>
<p>From a bivariate normal distribution with means (26, -2), variances (5, 0.25) and covariance -0.5, draw 100 samples. These represent the patient-level intercepts and slopes. Paste the values to basdat. Make sure the column names in basdat are informative. Also make sure that the class of basdat remains “data.frame”.</p>
</blockquote>
<p>The covariance of <span class="math inline">\(&lt;0\)</span> means that we model that patients with higher intercepts (‘baseline CD4 count’), the slope is more negative, so the CD4 count goes down faster.</p>
<pre class="r"><code>require(mvtnorm)
means &lt;- c(26, -2)
variances &lt;- c(5, 0.25)
covariance &lt;- -0.5

cov_mat &lt;- matrix(c(variances[1], covariance, covariance, variances[2]), 
                  nrow = 2, byrow = T)

set.seed(2)
samp1 &lt;-rmvnorm(n = nrow(basdat), mean = means, sigma = cov_mat)

str(samp1)</code></pre>
<pre><code> num [1:100, 1:2] 24 29.7 25.8 27.6 30.4 ...</code></pre>
<p>Check means, variances and covariance</p>
<pre class="r"><code>mean(samp1[, 1]); var(samp1[, 1])</code></pre>
<pre><code>[1] 26.23858</code></pre>
<pre><code>[1] 5.442759</code></pre>
<pre class="r"><code>mean(samp1[, 2]); var(samp1[, 2])</code></pre>
<pre><code>[1] -2.064848</code></pre>
<pre><code>[1] 0.3031027</code></pre>
<pre class="r"><code>cov(samp1[, 1], samp1[, 2])</code></pre>
<pre><code>[1] -0.5774269</code></pre>
<p>Plot</p>
<pre class="r"><code>plot(samp1[,1], samp1[, 2])</code></pre>
<p><img src="figure/cs_assignments.Rmd/unnamed-chunk-33-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Add to data.frame</p>
<pre class="r"><code>basdat %&lt;&gt;% 
  mutate(intercept = samp1[, 1], slope = samp1[, 2])
head(basdat)</code></pre>
<pre><code>  id intercept     slope
1  1  23.96704 -1.747633
2  2  29.74817 -2.819619
3  3  25.79658 -1.923623
4  4  27.62208 -2.242741
5  5  30.44786 -2.432938
6  6  26.74836 -1.621789</code></pre>
</div>
<div id="c-add-follow-up" class="section level3">
<h3>C add follow-up</h3>
<blockquote>
<p>We (simply) assume these patients are all followed for 10 years. However, the number of CD4 measurements differs between patients. From a Poisson distribution, draw a vector of numbers of measurements, with a mean of 5 (= lambda). Make sure these draws will be a new column of basdat. Call the column nmeas.</p>
</blockquote>
<pre class="r"><code>basdat %&lt;&gt;% 
  mutate(nmeas = rpois(nrow(basdat), lambda = 5))</code></pre>
</div>
<div id="d-validity-check" class="section level3">
<h3>D Validity check</h3>
<blockquote>
<p>Check for zeros in nmeas, convert these all to 1 for simplicity. Note that in reality, allowing for the zeros will be more realistic.</p>
</blockquote>
<p>Use data.table</p>
<pre class="r"><code>setDT(basdat)
basdat[nmeas == 0, .N]</code></pre>
<pre><code>[1] 1</code></pre>
<p>Change to 1</p>
<pre class="r"><code>basdat[nmeas == 0, nmeas:=1]</code></pre>
</div>
<div id="e-simulate-single-patient" class="section level3">
<h3>E simulate single patient</h3>
<blockquote>
<p>Now we will simulate and plot longitudinal data for the first patient (we will repeat the process for the patients 2-100 later). Make a dataframe “longdat”, which will contain the simulated CD4 measurements. At first put in this dataframe the patient ID, repeated according to the value of nmeas for patient 1. Hint: you can use rep(). Also put in the individual slope and intercept for patient 1.</p>
</blockquote>
<pre class="r"><code>longdat &lt;- basdat[id == 1, {
  .SD %&gt;%             # take the columns as specified by .SDcols
    map(rep, nmeas)   # repeat each one nmeas times
}, .SDcols = c(&quot;id&quot;, &quot;intercept&quot;, &quot;slope&quot;)]</code></pre>
</div>
<div id="f-simulate-measure-times" class="section level3">
<h3>F simulate measure times</h3>
<blockquote>
<p>In longdat, simulate the measurement times, drawn from the uniform distribution on (0, 10).</p>
</blockquote>
<p>For readibility, sort on time</p>
<pre class="r"><code>longdat[, times:=runif(n = .N, min = 0, max = 10)]
setorder(longdat, times)
print(longdat)</code></pre>
<pre><code>   id intercept     slope    times
1:  1  23.96704 -1.747633 2.344975
2:  1  23.96704 -1.747633 3.426912
3:  1  23.96704 -1.747633 4.296028
4:  1  23.96704 -1.747633 5.599569
5:  1  23.96704 -1.747633 6.920055
6:  1  23.96704 -1.747633 7.367007</code></pre>
</div>
<div id="g-simulate-measurements" class="section level3">
<h3>G Simulate measurements</h3>
<blockquote>
<p>In longdat, compute the “true” square root of CD4, based on the intercept, slope and time. To this “true” value, add normally distributed noise with mean = 0 and SD = 1. This will give the simulated CD4 measurements (on the square root scale). Now compute measured CD4 count itself by squaring.</p>
</blockquote>
<p>With dplyr, we can nicely mutate variables after each other</p>
<pre class="r"><code>longdat %&lt;&gt;%
  mutate(true_CD4 = intercept + slope * times,
         CD4_sqrt = true_CD4 + rnorm(nrow(longdat), mean = 0, sd = 1),
         CD4      = CD4_sqrt^2) %&gt;% data.table()
head(longdat)</code></pre>
<pre><code>   id intercept     slope    times true_CD4 CD4_sqrt      CD4
1:  1  23.96704 -1.747633 2.344975 19.86888 19.54934 382.1767
2:  1  23.96704 -1.747633 3.426912 17.97806 18.82151 354.2491
3:  1  23.96704 -1.747633 4.296028 16.45916 16.94282 287.0590
4:  1  23.96704 -1.747633 5.599569 14.18105 13.87738 192.5816
5:  1  23.96704 -1.747633 6.920055 11.87332 11.58823 134.2870
6:  1  23.96704 -1.747633 7.367007 11.09222 12.07265 145.7489</code></pre>
</div>
<div id="h-plot" class="section level3">
<h3>H Plot</h3>
<blockquote>
<p>Try to make a pretty plot of measured CD4 count against follow-up time for patient 1. Suggestion: use xlim and ylim, to at least display 0 for both axes.</p>
</blockquote>
<pre class="r"><code>longdat %&gt;%
  ggplot(aes(x = times, y = CD4)) + 
  geom_line() + 
  lims(x = c(0, max(longdat$times)), y = c(0, max(longdat$CD4))) + 
  theme_minimal()</code></pre>
<p><img src="figure/cs_assignments.Rmd/unnamed-chunk-41-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="i-for-all-patients" class="section level3">
<h3>I for all patients</h3>
<blockquote>
<p>Some more fun: put together all the code used to simulate and plot the data for patient 1. Now replace the number 1, indicating patient 1, by the letter i. Try: with first defining i &lt;- 1, the same plot as before will be produced. In the main title of the plot, make sure that the patient ID (based on i) is plotted. (HINT: find out how to use paste()). Try it also with i &lt;- 2. Now put your syntax within a “loop” with i ranging from 1 to 100. (Hint: place for (i in 1:100){ before and } after your code). Final step, make sure the output of the loop is send to a PDF plot. Look at the plot, scroll through. Be proud.</p>
</blockquote>
<p>By writing the code with data.table, it is now easy to do this for each patient</p>
<pre class="r"><code>longdat2 &lt;- basdat[, {
  .SD %&gt;%             # take the columns as specified by .SDcols
    map(rep, nmeas)   # repeat each one nmeas times
}, .SDcols = c(&quot;intercept&quot;, &quot;slope&quot;), by = &quot;id&quot;]
print(longdat2)</code></pre>
<pre><code>      id intercept     slope
  1:   1  23.96704 -1.747633
  2:   1  23.96704 -1.747633
  3:   1  23.96704 -1.747633
  4:   1  23.96704 -1.747633
  5:   1  23.96704 -1.747633
 ---                        
536: 100  24.22942 -2.187417
537: 100  24.22942 -2.187417
538: 100  24.22942 -2.187417
539: 100  24.22942 -2.187417
540: 100  24.22942 -2.187417</code></pre>
<p>Simulate times. Note that it does not matter whether we do this for each patient separately or all at the same time.</p>
<pre class="r"><code>longdat2[, times:=runif(n = .N, min = 0, max = 10)]
setorder(longdat2, times)</code></pre>
<p>Add simulated CD4 counts, also not needed to do this by patient, since for each line we have a time, intercept and slope</p>
<pre class="r"><code>longdat2 %&lt;&gt;%
  mutate(true_CD4 = intercept + slope * times,
         CD4_sqrt = true_CD4 + rnorm(n(), mean = 0, sd = 1), # n() counts the number of rows
         CD4      = CD4_sqrt^2) %&gt;% 
  data.table()</code></pre>
<p>Create a plot of all patients at the same time</p>
<pre class="r"><code>longdat2 %&gt;%
  mutate(id = factor(id)) %&gt;%
  ggplot(aes(x = times, y = CD4, col = id)) + 
  geom_line() + 
  lims(x = c(0, max(longdat2$times)), y = c(0, max(longdat2$CD4))) + 
  theme_minimal()</code></pre>
<p><img src="figure/cs_assignments.Rmd/unnamed-chunk-45-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Create a plot for each patient separately (only 4 are shown here)</p>
<pre class="r"><code>longdat2[id %in% unique(id)[1:4]] %&gt;%
  mutate(id = factor(id)) %&gt;%
  ggplot(aes(x = times, y = CD4)) + 
  geom_line() + 
  lims(x = c(0, max(longdat2$times)), y = c(0, max(longdat2$CD4))) + 
  theme_minimal() + 
  facet_wrap(~id, scales = &quot;fixed&quot;)</code></pre>
<p><img src="figure/cs_assignments.Rmd/unnamed-chunk-46-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>To create pdfs separately for each patient, we will use looping.</p>
<p>Let’s only use 3 patients here</p>
<pre class="r"><code>for (i in 1:3) {
  longdat2[id == i] %&gt;%
  ggplot(aes(x = times, y = CD4)) + 
    geom_line() + 
    lims(x = c(0, max(longdat2$times)), y = c(0, max(longdat2$CD4))) + 
    theme_minimal() + 
    ggtitle(&quot;CD4 number over time&quot;, paste0(&quot;patient &quot;, i))
  ggsave(filename = here(&quot;figs&quot;, paste0(&quot;patient_&quot;, i, &quot;.pdf&quot;)), device = &quot;pdf&quot;)
}</code></pre>
<p>Or to put them all in one file</p>
<pre class="r"><code>plots &lt;- vector(&quot;list&quot;, nrow(basdat))
for (i in 1:nrow(basdat)) {
  plots[[i]] &lt;- 
    longdat2[id == i] %&gt;%
    ggplot(aes(x = times, y = CD4)) + 
      geom_line() + 
      lims(x = c(0, max(longdat2$times)), y = c(0, max(longdat2$CD4))) + 
      theme_minimal() + 
      ggtitle(&quot;CD4 number over time&quot;, paste0(&quot;patient &quot;, i))
}</code></pre>
<p>To save them in a single pdf with one page per patient (this takes some time)</p>
<pre class="r"><code>require(gridExtra)

pdf(here(&quot;figs&quot;, &quot;cd4_vs_time.pdf&quot;), onefile = T)
for (i in seq(length(plots))) {
  grid.arrange(plots[[i]])  
}
dev.off()</code></pre>
<p>Now be proud ;)</p>
</div>
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<!-- Insert the session information into the document -->
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 3.4.3 (2017-11-30)
Platform: x86_64-apple-darwin15.6.0 (64-bit)
Running under: macOS Sierra 10.12.6

Matrix products: default
BLAS: /Library/Frameworks/R.framework/Versions/3.4/Resources/lib/libRblas.0.dylib
LAPACK: /Library/Frameworks/R.framework/Versions/3.4/Resources/lib/libRlapack.dylib

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] bindrcpp_0.2        mvtnorm_1.0-7       ggplot2_2.2.1      
[4] here_0.1            purrr_0.2.4         magrittr_1.5       
[7] data.table_1.10.4-3 dplyr_0.7.4        

loaded via a namespace (and not attached):
 [1] Rcpp_0.12.14     pillar_1.1.0     compiler_3.4.3   git2r_0.20.0    
 [5] plyr_1.8.4       bindr_0.1        tools_3.4.3      digest_0.6.14   
 [9] evaluate_0.10.1  tibble_1.4.1     gtable_0.2.0     pkgconfig_2.0.1 
[13] rlang_0.1.6      cli_1.0.0        yaml_2.1.16      stringr_1.2.0   
[17] knitr_1.18       gtools_3.5.0     rprojroot_1.2    grid_3.4.3      
[21] glue_1.2.0       R6_2.2.2         rmarkdown_1.8    gdata_2.18.0    
[25] backports_1.1.2  scales_0.5.0     htmltools_0.3.6  gmodels_2.16.2  
[29] MASS_7.3-47      assertthat_0.2.0 colorspace_1.3-2 labeling_0.3    
[33] utf8_1.1.3       stringi_1.1.6    lazyeval_0.2.1   munsell_0.4.3   
[37] crayon_1.3.4    </code></pre>
</div>
</div>

<hr>
<p>
    This <a href="http://rmarkdown.rstudio.com">R Markdown</a> site was created with <a href="https://github.com/jdblischak/workflowr">workflowr</a>
</p>
<hr>

<!-- To enable disqus, uncomment the section below and provide your disqus_shortname -->

<!-- disqus
  <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'rmarkdown'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
-->


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
